<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Nammo Billing — Simple POS (Frontend Demo)</title>
<meta name="description" content="Nammo Billing - front-end demo (signup, products, CSV import, billing, admin/staff roles)"/>
<style>
  :root{--accent:#0b84ff;--danger:#dc3545;--muted:#6b7280;--bg:#0f1724;--card:#0b1220}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial; margin:0; background:linear-gradient(180deg,#081225,#071428); color:#e6eef6}
  .wrap{max-width:1100px;margin:22px auto;padding:18px}
  header{display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:20px}
  .lead{color:var(--muted);font-size:13px}
  nav{margin-left:auto;display:flex;gap:8px}
  button, .btn{background:var(--accent);color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
  .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input, select, textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  .muted{color:var(--muted);font-size:13px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .danger{background:var(--danger);padding:6px 10px;border-radius:8px;color:#fff;border:0}
  .center{display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:8px}
  .product-suggestion{cursor:pointer;padding:6px;border-radius:6px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Nammo Billing</h1>
        <div class="lead">Simple POS (frontend demo) — Signup → Products → Quick Sale</div>
      </div>
      <nav id="topNav">
        <span id="who" class="muted">Not signed in</span>
        <button class="btn" id="btnShowLogin">Login / Signup</button>
      </nav>
    </header>

    <main class="grid">
      <section>
        <!-- DASHBOARD (changes by view) -->
        <div id="viewDashboard" class="card">
          <h2>Dashboard</h2>
          <div class="small muted">Quick actions</div>
          <div style="margin-top:10px" class="row">
            <button class="btn" id="goProducts">Products</button>
            <button class="btn" id="goBilling">Quick Sale</button>
            <button class="btn" id="goUsers">Manage Users</button>
            <button class="btn ghost" id="exportData">Export Data (JSON)</button>
          </div>
          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)"/>
          <div>
            <strong>Inventory summary</strong>
            <div id="invSummary" class="muted small" style="margin-top:8px">Loading...</div>
          </div>
        </div>

        <!-- PRODUCTS -->
        <div id="viewProducts" class="card hidden">
          <h2>Products — Manual & CSV Import</h2>
          <div class="small muted">Create or upload product list. Barcode is optional.</div>

          <label>Product name</label>
          <input id="p_name" placeholder="e.g. Archie Masala"/>

          <label>Price (₹)</label>
          <input id="p_price" type="number" step="0.01" placeholder="100"/>

          <label>Quantity</label>
          <input id="p_qty" type="number" placeholder="10"/>

          <label>Barcode (optional)</label>
          <input id="p_barcode" placeholder="1234567890123"/>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" id="addProduct">Add / Update Product</button>
            <button class="btn ghost" id="clearProducts">Clear All (admin only)</button>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)"/>

          <div>
            <label>Upload CSV (Excel -> Save as CSV)</label>
            <input id="csvFile" type="file" accept=".csv"/>
            <div class="small muted">CSV format: name,price,qty,barcode (header optional)</div>
            <div style="margin-top:8px"><button class="btn" id="importCSV">Import CSV</button></div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)"/>

          <h3 style="margin:0">Product list</h3>
          <div style="max-height:280px;overflow:auto;margin-top:8px">
            <table id="productTable"><thead><tr><th>Name</th><th>Price</th><th>Qty</th><th>Barcode</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- BILLING -->
        <div id="viewBilling" class="card hidden">
          <h2>Quick Sale</h2>
          <div class="small muted">Add items, apply discount & GST, then Complete Sale to reduce stock.</div>

          <label>Search product (by name or barcode)</label>
          <input id="searchProd" placeholder="Type product or scan barcode"/>

          <div id="suggestions" style="margin-top:6px"></div>

          <div style="margin-top:10px">
            <table id="cartTable"><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <label style="margin:0">Discount</label>
            <select id="discType"><option value="percent">Percent %</option><option value="fixed">Fixed ₹</option></select>
            <input id="discVal" type="number" value="0" style="width:120px"/>
            <label style="margin:0">GST</label>
            <select id="gstRate"><option value="0">No GST</option><option value="5">5%</option><option value="12">12%</option><option value="18" selected>18%</option></select>
            <button class="btn" id="completeSale">Complete Sale</button>
          </div>

          <div style="margin-top:12px" class="muted small" id="billSummary"></div>
        </div>

        <!-- USERS (Admin & Staff) -->
        <div id="viewUsers" class="card hidden">
          <h2>Users</h2>
          <div class="small muted">Create staff & manage expiry. First created account becomes Admin.</div>

          <label>First name</label><input id="u_fname"/>
          <label>Last name</label><input id="u_lname"/>
          <label>Phone</label><input id="u_phone"/>
          <label>Email</label><input id="u_email"/>
          <label>Password</label><input id="u_pass" type="password"/>
          <label>Role</label>
          <select id="u_role">
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
          <label>Expiry date (yyyy-mm-dd)</label><input id="u_expiry" type="date"/>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" id="createUser">Create user</button>
            <button class="btn ghost" id="listUsers">View users</button>
          </div>

          <div style="margin-top:12px;max-height:220px;overflow:auto">
            <table id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Expiry</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>

      </section>

      <aside>
        <div class="card">
          <h3>Account</h3>
          <div id="accountBox">
            <div class="muted small">No active session</div>
            <div style="margin-top:8px">
              <button class="btn" id="btnLogin">Login</button>
              <button class="btn ghost" id="btnSignup">Signup</button>
            </div>
          </div>

          <div style="margin-top:12px" class="hidden" id="adminActions">
            <h4>Admin</h4>
            <div class="small muted">Admin-only controls</div>
            <label>Extend user expiry (email)</label>
            <input id="extendEmail"/>
            <label>New expiry date</label>
            <input id="extendDate" type="date"/>
            <div style="margin-top:8px"><button class="btn" id="btnExtend">Extend</button></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h4>About</h4>
          <div class="small muted">Product name: <strong>Nammo Billing</strong></div>
          <div style="margin-top:8px">
            <button class="btn ghost" id="signOut">Sign out</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>Nammo Billing — Demo frontend. Not secure for production. For backend upgrade, ask me.</footer>
  </div>

<script>
/* =======================
   Simple client-side POS
   - localStorage used: users, products, sales
   - passwords: base64 (NOT secure) — use server auth later
   ======================= */

const STORAGE_USERS = 'nammo_users_v1';
const STORAGE_PRODUCTS = 'nammo_products_v1';
const STORAGE_SALES = 'nammo_sales_v1';
const SESSION_KEY = 'nammo_session_v1';

// init helpers
function nowIso(){ return new Date().toISOString(); }
function todayDateISO(){ return new Date().toISOString().slice(0,10); }
function load(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){return []}}
function save(key,data){ localStorage.setItem(key, JSON.stringify(data)); }
function saveObj(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function readObj(key){ try{return JSON.parse(localStorage.getItem(key));}catch(e){return null} }
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function b64(s){ return btoa(s); }
function unb64(s){ try{return atob(s);}catch(e){return s} }
function formatMoney(n){ return '₹' + Number(n).toFixed(2); }

// initial seed: create default admin if none exist
let users = load(STORAGE_USERS);
if(users.length===0){
  const admin = { id: uid(), first:'Admin', last:'User', phone:'', email:'admin@nammo.local', pass:b64('admin123'), role:'admin', expiry: '2099-12-31', created: nowIso() };
  users.push(admin); save(STORAGE_USERS, users);
}

// products and sales
let products = load(STORAGE_PRODUCTS);
let sales = load(STORAGE_SALES);

// session
let session = readObj(SESSION_KEY) || null;

// UI refs
const who = document.getElementById('who');
const btnShowLogin = document.getElementById('btnShowLogin');
const btnLogin = document.getElementById('btnLogin');
const btnSignup = document.getElementById('btnSignup');
const signOutBtn = document.getElementById('signOut');
const viewDashboard = document.getElementById('viewDashboard');
const viewProducts = document.getElementById('viewProducts');
const viewBilling = document.getElementById('viewBilling');
const viewUsers = document.getElementById('viewUsers');
const goProducts = document.getElementById('goProducts');
const goBilling = document.getElementById('goBilling');
const goUsers = document.getElementById('goUsers');
const productTable = document.querySelector('#productTable tbody');
const usersTable = document.querySelector('#usersTable tbody');
const invSummary = document.getElementById('invSummary');
const adminActions = document.getElementById('adminActions');
const accountBox = document.getElementById('accountBox');

// simple navigation
function show(view){
  [viewDashboard, viewProducts, viewBilling, viewUsers].forEach(v=>v.classList.add('hidden'));
  view.classList.remove('hidden');
}
show(viewDashboard);

// render top bar / account
function renderAccount(){
  users = load(STORAGE_USERS);
  products = load(STORAGE_PRODUCTS);
  sales = load(STORAGE_SALES);
  session = readObj(SESSION_KEY);
  if(session){
    who.textContent = session.name + ' • ' + session.role;
    accountBox.innerHTML = <div class="small">Signed in as <strong>${session.name}</strong> (${session.email})</div>;
    const adminPanel = session.role === 'admin' ? '' : 'hidden';
    adminActions.classList.toggle('hidden', session.role !== 'admin');
  } else {
    who.textContent = 'Not signed in';
    accountBox.innerHTML = `<div class="muted small">No active session</div>
      <div style="margin-top:8px"><button class="btn" id="btnLogin2">Login</button>
      <button class="btn ghost" id="btnSignup2">Signup</button></div>`;
    document.getElementById('btnLogin2').addEventListener('click', ()=>openAuth('login'));
    document.getElementById('btnSignup2').addEventListener('click', ()=>openAuth('signup'));
  }
  refreshInventorySummary();
}
renderAccount();

// AUTH / modal simple prompts
function openAuth(mode){
  if(mode==='login'){
    const email = prompt('Email (login):');
    const pass = prompt('Password:');
    if(!email || !pass) return alert('Cancelled');
    const u = users.find(x=>x.email.toLowerCase()===email.toLowerCase());
    if(!u) return alert('No user found');
    // expiry check
    if(u.expiry && u.expiry !== '' && u.expiry < todayDateISO()){
      return alert('Account expired. Contact admin.');
    }
    if(unb64(u.pass) !== pass) return alert('Wrong password');
    session = { id:u.id, name: u.first + ' ' + u.last, email:u.email, role:u.role };
    saveObj(SESSION_KEY, session);
    renderAccount();
    alert('Signed in');
  } else {
    // signup flow
    const first = prompt('First name:') || '';
    const last = prompt('Last name:') || '';
    const phone = prompt('Phone:') || '';
    const email = prompt('Email:');
    const pass = prompt('Password (min 4 chars):');
    if(!email || !pass) return alert('Cancelled');
    // if first user (no users) make admin - already seeded; but allow admin creation only by admin via UI
    if(users.find(x=>x.email.toLowerCase()===email.toLowerCase())) return alert('Email exists');
    // default expiry 2099 if admin creates; else 1 year
    const expiry = new Date(); expiry.setFullYear(expiry.getFullYear() + 1);
    const u = { id: uid(), first, last, phone, email, pass: b64(pass), role:'staff', expiry: expiry.toISOString().slice(0,10), created: nowIso() };
    users.push(u); save(STORAGE_USERS, users);
    alert('Signup success. Ask admin to promote to admin if needed.');
  }
}

// top nav buttons
btnShowLogin.addEventListener('click', ()=> openAuth('login'));
btnLogin.addEventListener('click', ()=> openAuth('login'));
btnSignup.addEventListener('click', ()=> openAuth('signup'));
signOutBtn.addEventListener('click', ()=> { localStorage.removeItem(SESSION_KEY); session=null; renderAccount(); alert('Signed out'); });

// navigation
goProducts.addEventListener('click', ()=> { show(viewProducts); renderProducts(); });
goBilling.addEventListener('click', ()=> { show(viewBilling); renderProducts(); renderCart(); });
goUsers.addEventListener('click', ()=> { show(viewUsers); renderUsers(); });

// PRODUCTS
function renderProducts(){
  products = load(STORAGE_PRODUCTS);
  productTable.innerHTML = '';
  products.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${formatMoney(p.price)}</td><td>${p.qty}</td><td>${escapeHtml(p.barcode||'')}</td>
      <td><button class="btn ghost" data-id="${p.id}" data-act="edit">Edit</button> <button class="danger" data-id="${p.id}" data-act="del">Delete</button></td>`;
    productTable.appendChild(tr);
  });
  // wire
  [...productTable.querySelectorAll('button')].forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.target.getAttribute('data-id');
      const act = e.target.getAttribute('data-act');
      if(act==='edit'){ const p = products.find(x=>x.id===id); if(p){document.getElementById('p_name').value=p.name;document.getElementById('p_price').value=p.price;document.getElementById('p_qty').value=p.qty;document.getElementById('p_barcode').value=p.barcode||'';} show(viewProducts); }
      if(act==='del'){ if(!confirm('Delete product?')) return; products = products.filter(x=>x.id!==id); save(STORAGE_PRODUCTS, products); renderProducts(); refreshInventorySummary(); }
    });
  });
}

document.getElementById('addProduct').addEventListener('click', ()=>{
  if(!session || session.role!=='admin') return alert('Only admin can add or update products');
  const name = document.getElementById('p_name').value.trim();
  const price = Number(document.getElementById('p_price').value) || 0;
  const qty = Number(document.getElementById('p_qty').value) || 0;
  const barcode = document.getElementById('p_barcode').value.trim();
  if(!name) return alert('Name required');
  // update if exists by name or barcode
  let p = products.find(x=>x.name.toLowerCase()===name.toLowerCase() || (barcode && x.barcode===barcode));
  if(p){
    p.price = price; p.qty = qty; p.barcode = barcode;
  } else {
    p = { id: uid(), name, price, qty, barcode, created: nowIso() };
    products.push(p);
  }
  save(STORAGE_PRODUCTS, products); renderProducts(); refreshInventorySummary();
  alert('Product saved');
  document.getElementById('p_name').value='';document.getElementById('p_price').value='';document.getElementById('p_qty').value='';document.getElementById('p_barcode').value='';
});

document.getElementById('clearProducts').addEventListener('click', ()=>{
  if(!session || session.role!=='admin') return alert('Only admin');
  if(!confirm('Clear ALL products? This cannot be undone.')) return;
  products = []; save(STORAGE_PRODUCTS, products); renderProducts(); refreshInventorySummary();
});

// CSV import
document.getElementById('importCSV').addEventListener('click', ()=>{
  if(!session || session.role!=='admin') return alert('Only admin can import CSV');
  const f = document.getElementById('csvFile').files[0];
  if(!f) return alert('Choose a CSV file');
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    importProductsFromCSV(text);
  };
  reader.readAsText(f);
});
function importProductsFromCSV(text){
  // simple parser: split lines, comma separated
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  lines.forEach((ln,i)=>{
    const cols = ln.split(',');
    // allow header detection (if contains 'name' or 'price' words)
    if(i===0 && /name/i.test(cols[0]) && /price/i.test(cols[1])) return;
    const name = (cols[0]||'').trim();
    const price = Number((cols[1]||'0').trim())||0;
    const qty = Number((cols[2]||'0').trim())||0;
    const barcode = (cols[3]||'').trim();
    if(!name) return;
    let p = products.find(x=>x.name.toLowerCase()===name.toLowerCase() || (barcode && x.barcode===barcode));
    if(p){ p.price = price; p.qty = qty; p.barcode = barcode; }
    else { products.push({ id: uid(), name, price, qty, barcode, created: nowIso() }); }
  });
  save(STORAGE_PRODUCTS, products); renderProducts(); refreshInventorySummary(); alert('CSV imported');
}

// USERS
function renderUsers(){
  users = load(STORAGE_USERS);
  usersTable.innerHTML = '';
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(u.first+' '+u.last)}</td><td>${escapeHtml(u.email)}</td><td>${u.role}</td><td>${u.expiry||''}</td>
      <td>${session && session.role==='admin' ? <button class="btn" data-id="${u.id}" data-act="prom">Promote</button> <button class="btn ghost" data-id="${u.id}" data-act="del">Delete</button> : ''}</td>`;
    usersTable.appendChild(tr);
  });
  [...usersTable.querySelectorAll('button')].forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.target.getAttribute('data-id'); const act = e.target.getAttribute('data-act');
      if(act==='prom'){ if(!confirm('Make this user admin?')) return; const u = users.find(x=>x.id===id); if(u){ u.role='admin'; save(STORAGE_USERS, users); renderUsers(); alert('Promoted');} }
